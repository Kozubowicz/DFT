#include <stdio.h>
#include <avr/io.h>
#include <util/delay.h>
#include <avr/pgmspace.h>
#include <math.h>

#define MAX7219_DDR DDRD
#define MAX7219_PORT PORTD
#define MAX7219_DININPUT PD3
#define MAX7219_CLKINPUT PD4
#define MAX7219_LOADINPUT PD2
#define Number 2
#define N 32
int COL [] = {0x00, 0x80, 0xC0, 0xE0,0xF0,0xF8,0xFC, 0xFE, 0xFF};

uint8_t ROW [16];
uint8_t ROWp [16];


uint16_t f[N];
int angle;
float cs, ss;
uint8_t x, k;


void spi();
void max_init();
void clean();
void max7219_send();
void max7219_digit();
void TRANSFORM();
uint16_t analogRead();


const int16_t cosine_lookup[] PROGMEM =
{
	1000, 980, 923, 831, 707, 555, 382, 195, 0, -195, -382, -555, -707, -831, -923, -980, -1000, -980, -923, -831, -707, -555, -382, -195, 0, 195, 382, 555, 707, 831, 923, 980, 1000,923, 707, 382, 0, -382, -707, -923, -1000, -923, -707, -382, 0, 382, 707, 923, 1000, 923, 707, 382, 0, -382, -707, -923, -1000, -923, -707, -382, 0, 382, 707, 923, 1000, 831, 382, -195, -707, -980, -923, -555, 0, 555, 923, 980, 707, 195, -382, -831, -1000, -831, -382, 195, 707, 980, 923, 555, 0, -555, -923, -980, -707, -195, 382, 831, 1000, 707, 0, -707, -1000, -707, 0, 707, 1000, 707, 0, -707, -1000, -707, 0, 707, 999, 707, 0, -707, -1000, -707, 0, 707, 1000, 707, 0, -707, -1000, -707, 0, 707, 1000, 555, -382, -980, -707, 195, 923, 831, 0, -831, -923, -195, 707, 980, 382, -555, -1000, -555, 382, 980, 707, -195, -923, -831, 0, 831, 923, 195, -707, -980, -382, 555, 1000, 382, -707, -923, 0, 923, 707, -382, -1000, -382, 707, 923, 0, -923, -707, 382, 1000, 382, -707, -923, 0, 923, 707, -382, -1000, -382, 707, 923, 0, -923, -707, 382, 1000, 195, -923, -555, 707, 831, -382, -980, 0, 980, 382, -831, -707, 555, 923, -195, -1000, -195, 923, 555, -707, -831, 382, 980, 0, -980, -382, 831, 707, -555, -923, 195, 1000, 0, -1000, 0, 1000, 0, -1000, 0, 999, 0, -1000, 0, 1000, 0, -1000, 0, 1000, 0, -1000, 0, 1000, 0, -1000, 0, 1000, 0, -1000, 0, 1000, 0, -1000, 0, 1000, -195, -923, 555, 707, -831, -382, 980, 0, -980, 382, 831, -707, -555, 923, 195, -1000, 195, 923, -555, -707, 831, 382, -980, 0, 980, -382, -831, 707, 555, -923, -195, 1000, -382, -707, 923, 0, -923, 707, 382, -1000, 382, 707, -923, 0, 923, -707, -382, 1000, -382, -707, 923, 0, -923, 707, 382, -1000, 382, 707, -923, 0, 923, -707, -382, 1000, -555, -382, 980, -707, -195, 923, -831, 0, 831, -923, 195, 707, -980, 382, 555, -1000, 555, 382, -980, 707, 195, -923, 831, 0, -831, 923, -195, -707, 980, -382, -555, 1000, -707, 0, 707, -1000, 707, 0, -707, 1000, -707, 0, 707, -1000, 707, 0, -707, 1000, -707, 0, 707, -1000, 707, 0, -707, 1000, -707, 0, 707, -1000, 707, 0, -707, 1000, -831, 382, 195, -707, 980, -923, 555, 0, -555, 923, -980, 707, -195, -382, 831, -1000, 831, -382, -195, 707, -980, 923, -555, 0, 555, -923, 980, -707, 195, 382, -831, 1000, -923, 707, -382, 0, 382, -707, 923, -1000, 923, -707, 382, 0, -382, 707, -923, 1000, -923, 707, -382, 0, 382, -707, 923, -1000, 923, -707, 382, 0, -382, 707, -923, 1000, -980, 923, -831, 707, -555, 382, -195, 0, 195, -382, 555, -707, 831, -923, 980, -1000, 980, -923, 831, -707, 555, -382, 195, 0, -195, 382, -555, 707, -831, 923, -980, 1000, -1000, 1000, -1000, 999, -1000, 1000, -1000, 1000, -1000, 1000, -1000, 1000, -1000, 1000, -1000, 1000, -1000, 1000, -1000, 1000, -1000, 1000, -999, 1000, -1000, 1000, -1000, 1000, -999, 1000, -1000
};

const int16_t sine_lookup[] PROGMEM =
{
	0, 195, 382, 555, 707, 831, 923, 980, 1000, 980, 923, 831, 707, 555, 382, 195,
	0, -195, -382, -555, -707, -831, -923, -980, -1000, -980, -923, -831, -707, -555, -382, -195,
	0, 382, 707, 923, 1000, 923, 707, 382, 0, -382, -707, -923, -1000, -923, -707, -382,
	0, 382, 707, 923, 999, 923, 707, 382, 0, -382, -707, -923, -1000, -923, -707, -382,
	0, 555, 923, 980, 707, 195, -382, -831, -1000, -831, -382, 195, 707, 980, 923, 555,
	0, -555, -923, -980, -707, -195, 382, 831, 1000, 831, 382, -195, -707, -980, -923, -555,
	0, 707, 1000, 707, 0, -707, -1000, -707, 0, 707, 999, 707, 0, -707, -1000, -707,
	0, 707, 1000, 707, 0, -707, -1000, -707, 0, 707, 1000, 707, 0, -707, -1000, -707,
	0, 831, 923, 195, -707, -980, -382, 555, 999, 555, -382, -980, -707, 195, 923, 831,
	0, -831, -923, -195, 707, 980, 382, -555, -1000, -555, 382, 980, 707, -195, -923, -831,
	0, 923, 707, -382, -1000, -382, 707, 923, 0, -923, -707, 382, 1000, 382, -707, -923,
	0, 923, 707, -382, -1000, -382, 707, 923, 0, -923, -707, 382, 1000, 382, -707, -923,
	0, 980, 382, -831, -707, 555, 923, -195, -1000, -195, 923, 555, -707, -831, 382, 980,
	0, -980, -382, 831, 707, -555, -923, 195, 1000, 195, -923, -555, 707, 831, -382, -980,
	0, 1000, 0, -1000, 0, 999, 0, -1000, 0, 1000, 0, -1000, 0, 1000, 0, -1000, 0, 1000,
	0, -1000, 0, 1000, 0, -1000, 0, 1000, 0, -1000, 0, 1000, 0, -1000,
	0, 980, -382, -831, 707, 555, -923, -195, 1000, -195, -923, 555, 707, -831, -382, 980,
	0, -980, 382, 831, -707, -555, 923, 195, -1000, 195, 923, -555, -707, 831, 382, -980,
	0, 923, -707, -382, 999, -382, -707, 923, 0, -923, 707, 382, -1000, 382, 707, -923,
	0, 923, -707, -382, 1000, -382, -707, 923, 0, -923, 707, 382, -1000, 382, 707, -923,
	0, 831, -923, 195, 707, -980, 382, 555, -1000, 555, 382, -980, 707, 195, -923, 831,
	0, -831, 923, -195, -707, 980, -382, -555, 1000, -555, -382, 980, -707, -195, 923, -831,
	0, 707, -1000, 707, 0, -707, 1000, -707, 0, 707, -1000, 707, 0, -707, 1000, -707,
	0, 707, -1000, 707, 0, -707, 1000, -707, 0, 707, -999, 707, 0, -707, 999, -707,
	0, 555, -923, 980, -707, 195, 382, -831, 1000, -831, 382, 195, -707, 980, -923, 555,
	0, -555, 923, -980, 707, -195, -382, 831, -1000, 831, -382, -195, 707, -980, 923, -555,
	0, 382, -707, 923, -1000, 923, -707, 382, 0, -382, 707, -923, 1000, -923, 707, -382,
	0, 382, -707, 923, -1000, 923, -707, 382, 0, -382, 707, -923, 999, -923, 707, -382,
	0, 195, -382, 555, -707, 831, -923, 980, -1000, 980, -923, 831, -707, 555, -382, 195,
	0, -195, 382, -555, 707, -831, 923, -980, 999, -980, 923, -831, 707, -555, 382, -195,
	0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
};






int main(void) {
	spi();
	max_init();
	clean();

	//ADCSRA = 0xe5;
	//ADCSRA = 0x85;
	ADCSRA = (1<<ADEN) | 5;
	//ADCSRA =0b10000110;
	ADMUX = 0x40;
	while(1) {
		 for(k = 0; k < N; k++){
			 f[k] = analogRead();

		 }
		 TRANSFORM();
		 for(int r = 8; r>=0; r--){
			for(int c = 0; c<Number; c++){
				for(int i = 0; i<8 ; i++){
					if(ROW[(c*8)+i]<= r &&  r < ROWp[(c*8)+i]){
						max7219_digit(c, i, COL[r]);
					}
				}
			}
		_delay_ms(35);
		}

		for(int r = 0; r<9; r++){
			for(int c = 0; c<Number; c++){
				for(int i = 0; i<8 ; i++){
					if(ROW[(c*8)+i]>=r && r>ROWp[(c*8)+i]){
						max7219_digit(c, i, COL[r]);
					}
				}
			}
		_delay_ms(35);
		}
		for(int y = 0; y<16; y++){
			ROWp[y]= ROW[y];
		}
	}
}

void spi() {
	//output
	MAX7219_DDR |= (1 << MAX7219_DININPUT);
	MAX7219_DDR |= (1 << MAX7219_CLKINPUT);
	MAX7219_DDR |= (1 << MAX7219_LOADINPUT);
	//low
	MAX7219_PORT &= ~(1 << MAX7219_DININPUT);
	MAX7219_PORT &= ~(1 << MAX7219_CLKINPUT);
	MAX7219_PORT &= ~(1 << MAX7219_LOADINPUT);
}

void max_init(){
	for(int i=0; i<Number; i++) {
			max7219_send(i, 0x0C, 1);
			max7219_send(i, 0x0F, 0);
			max7219_send(i, 0x09, 0);
			max7219_send(i, 0x0A, 15);
			max7219_send(i, 0x0B, 7);
		}
}

void clean(){
	for(int z = 0; z<Number; z++){
		for(int x = 0; x < 8; x++){
			max7219_digit(z, x, 0x00);
		}
	}
}

void max7219_shiftout(int bytedata) {
	for(int j=8; j>0; j--){
		int val = (bytedata & (1<<(j-1)))>>(j-1);
		MAX7219_PORT &= ~(1 << MAX7219_CLKINPUT);
		if(val)
			MAX7219_PORT |= (1 << MAX7219_DININPUT);
		else
			MAX7219_PORT &= ~(1 << MAX7219_DININPUT);
		MAX7219_PORT |= (1 << MAX7219_CLKINPUT);
	}
}

void max7219_send(int ic, int reg, int data) {
	if(ic < Number) {
		MAX7219_PORT &= ~(1<<MAX7219_LOADINPUT);

		for(int i=ic; i<(Number-1); i++) {
			max7219_shiftout(0x00);
			max7219_shiftout(0x00);
		}

		max7219_shiftout(reg);
		max7219_shiftout(data);

		for(int i=0; i<ic; i++) {
			max7219_shiftout(0x00);
			max7219_shiftout(0x00);
		}
		MAX7219_PORT |= (1<<MAX7219_LOADINPUT);
	}
}

void max7219_digit(int i, int digit, int value) {
		max7219_send(i, digit+1, value);
}


void TRANSFORM(){
	for(int k = 0; k < 16; k++){
		cs = ss = 0;
		for(x = 0; x < N; x++){
			angle = x + (N*k);

				cs += (float)f[x]*(int16_t)pgm_read_word(&cosine_lookup[angle]);		//real part of dft
				ss += (float)f[x]*(int16_t)pgm_read_word(&sine_lookup[angle]);			//imaginary part of dft
		}
		cs /= N*1000;
		ss /= N*1000;
		int16_t V = sqrt((cs*cs)+(ss*ss));
		//if(V<2){
		//	V=0;
		//}
		ROW[k] = V;
	}
}

uint16_t analogRead(){
	uint16_t adcl, adch;
	ADCSRA |= (1<<ADSC);
	while((ADCSRA & (1<<ADSC)));
	adcl = ADCL;
	adch = ADCH;
	return((adch<<8)|adcl);
	//return ADC;
}



